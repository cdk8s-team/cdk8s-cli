import * as path from 'path';
import * as fs from 'fs-extra';
import * as pacmak from 'jsii-pacmak';
import * as pacmakv from 'jsii-pacmak/lib/targets/version-utils';
import { sscaff } from 'sscaff';
import * as yargs from 'yargs';

const pkgroot = path.join(__dirname, '..', '..', '..');

const pkg = fs.readJsonSync(path.join(pkgroot, 'package.json'));
const constructsVersion = pkg.dependencies.constructs.replace('^', '');

const templatesDir = path.join(pkgroot, 'templates');
const availableTemplates = fs.readdirSync(templatesDir).filter(x => !x.startsWith('.'));

class Command implements yargs.CommandModule {
  public readonly command = 'init TYPE';
  public readonly describe = 'Create a new cdk8s project from a template.';
  public readonly builder = (args: yargs.Argv) => args
    .positional('TYPE', { demandOption: true, desc: 'Project type' })
    .showHelpOnFail(false)
    .choices('TYPE', availableTemplates);

  public async handler(argv: any) {
    if (fs.readdirSync('.').filter(f => !f.startsWith('.')).length > 0) {
      console.error('Cannot initialize a project in a non-empty directory');
      process.exit(1);
    }

    console.error(`Initializing a project from the ${argv.type} template`);
    const templatePath = path.join(templatesDir, argv.type);
    const deps: any = await determineDeps();

    try {
      await sscaff(templatePath, '.', deps);
    } catch (er) {
      const e = er as any;
      throw new Error(`error during project initialization: ${e.stack}\nSTDOUT:\n${e.stdout?.toString()}\nSTDERR:\n${e.stderr?.toString()}`);
    }
  }
}

async function determineDeps(): Promise<Deps> {
  const cdk8s = new ModuleVersion('cdk8s', { jsii: true });
  const cdk8sPlus = new ModuleVersion('cdk8s-plus-22', { jsii: true });
  const cdk8sCli = new ModuleVersion('cdk8s-cli');
  const jsii = new ModuleVersion('jsii');

  return {
    npm_cdk8s: cdk8s.npmDependency,
    npm_cdk8s_plus: cdk8sPlus.npmDependency,
    pypi_cdk8s: cdk8s.pypiDependency,
    pypi_cdk8s_plus: cdk8sPlus.pypiDependency,
    mvn_cdk8s: cdk8s.mavenDependency,
    mvn_cdk8s_plus: cdk8sPlus.mavenDependency,
    cdk8s_core_version: cdk8s.version,
    cdk8s_plus_version: cdk8sPlus.version,
    constructs_version: constructsVersion,
    jsii_version: jsii.version,

    // do not attempt to install cdk8s cli if we are running in a test context
    npm_cdk8s_cli: process.env.CDK8S_TEST ? undefined : cdk8sCli.npmDependency,
  };
}

interface Deps {
  npm_cdk8s: string;
  npm_cdk8s_cli?: string;
  npm_cdk8s_plus: string;
  pypi_cdk8s: string;
  pypi_cdk8s_plus: string;
  mvn_cdk8s: string;
  mvn_cdk8s_plus: string;
  cdk8s_core_version: string;
  cdk8s_plus_version: string;
  constructs_version: string;
  jsii_version: string;
}

class ModuleVersion {
  public readonly pypiVersion: string;
  public readonly npmVersion: string;
  public readonly mavenVersion: string;
  public readonly version: string;

  private readonly jsii: boolean;

  constructor(private readonly moduleName: string, options: { jsii?: boolean } = { }) {
    this.version = this.resolveVersion(moduleName);
    this.npmVersion = this.version;
    this.pypiVersion = pacmakv.toReleaseVersion(this.version, pacmak.TargetName.PYTHON);
    this.mavenVersion = pacmakv.toReleaseVersion(this.version, pacmak.TargetName.JAVA);
    this.jsii = options.jsii ?? false;
  }

  public get npmTarballFile() {
    if (this.jsii) {
      return `${this.moduleName}@${this.version}.jsii.tgz`;
    } else {
      return `${this.moduleName}-v${this.version}.tgz`;
    }
  }

  public get pypiWheelFile() {
    const [major, minor, patch, pre] = this.pypiVersion.split('.');
    return `${this.moduleName.replace(/-/g, '_')}-${major}.${minor}.${patch}${pre ?? ''}-py3-none-any.whl`;
  }

  public get javaJarFile() {
    return `org/cdk8s/${this.moduleName}/${this.mavenVersion}/${this.moduleName}-${this.mavenVersion}.jar`;
  }

  public get npmDependency() {
    return `${this.moduleName}@^${this.npmVersion}`;
  }

  public get pypiDependency() {
    return `${this.moduleName}~=${this.pypiVersion}`;
  }

  public get mavenDependency() {
    return this.mavenVersion;
  }

  private resolveVersion(module: string): string {
    if (module === 'cdk8s-cli') {
      module = '../../../';
    }

    // eslint-disable-next-line @typescript-eslint/no-require-imports
    return require(`${module}/package.json`).version;
  }
}


module.exports = new Command();
